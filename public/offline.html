<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>dompetku</title>
    <!-- NO EXTERNAL RESOURCES - Everything is inlined for offline -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #f3e8ff 50%, #fce7f3 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            height: 64px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            color: #1e293b;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            font-size: 16px;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        /* Wallet Cards */
        .wallets-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            margin: 0 -16px;
            padding: 0 16px 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .wallets-scroll::-webkit-scrollbar {
            display: none;
        }

        .wallet-card {
            min-width: 280px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .wallet-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .wallet-icon.blue {
            background: rgba(59, 130, 246, 0.15);
        }

        .wallet-icon.purple {
            background: rgba(168, 85, 247, 0.15);
        }

        .wallet-icon.pink {
            background: rgba(236, 72, 153, 0.15);
        }

        .wallet-icon.green {
            background: rgba(16, 185, 129, 0.15);
        }

        .wallet-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .wallet-type {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
        }

        .wallet-balance {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .stat-card.full-width {
            grid-column: span 2;
        }

        .stat-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-icon.blue {
            background: rgba(59, 130, 246, 0.15);
        }

        .stat-icon.green {
            background: rgba(34, 197, 94, 0.15);
        }

        .stat-icon.red {
            background: rgba(239, 68, 68, 0.15);
        }

        .stat-label {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-value.small {
            font-size: 15px;
        }

        /* Transactions */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .transaction-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .transaction-category {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .transaction-date {
            font-size: 12px;
            color: #94a3b8;
        }

        .transaction-amount {
            font-size: 14px;
            font-weight: 600;
        }

        .transaction-amount.income {
            color: #16a34a;
        }

        .transaction-amount.expense {
            color: #1e293b;
        }

        /* Bottom Navigation */
        nav {
            height: 60px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            text-decoration: none;
            color: #94a3b8;
            font-size: 10px;
            font-weight: 500;
        }

        .nav-item.active {
            color: #2563eb;
        }

        .nav-item .nav-icon {
            font-size: 22px;
        }

        /* Offline Banner */
        .offline-banner {
            background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: #64748b;
        }

        .add-wallet-card {
            min-width: 280px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 24px;
            border: 2px dashed rgba(59, 130, 246, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #2563eb;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Offline Banner -->
        <div class="offline-banner">
            <span>üì∂</span>
            <span>Mode Offline - Menampilkan data tersimpan</span>
        </div>

        <header>
            <div class="logo">dompetku</div>
            <div class="avatar">üë§</div>
        </header>

        <main>
            <!-- Wallets Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Wallet Saya</h2>
                </div>
                <div id="wallets-container" class="wallets-scroll">
                    <!-- Wallets will be inserted here -->
                </div>
            </div>

            <!-- Stats Section -->
            <div class="section">
                <div class="stats-grid">
                    <div class="stat-card full-width">
                        <div class="stat-icon blue">üí∞</div>
                        <div class="stat-label">Total Saldo</div>
                        <div id="total-balance" class="stat-value">Rp 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üìà</div>
                        <div class="stat-label">Pemasukan</div>
                        <div id="total-income" class="stat-value small">Rp 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">üìâ</div>
                        <div class="stat-label">Pengeluaran</div>
                        <div id="total-expense" class="stat-value small">Rp 0</div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Transaksi Terakhir</h2>
                </div>
                <div id="transactions-container" class="card">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </main>

        <nav>
            <a href="/dashboard" class="nav-item active">
                <span class="nav-icon">üè†</span>
                <span>Home</span>
            </a>
            <a href="/transactions" class="nav-item">
                <span class="nav-icon">üìã</span>
                <span>Transaksi</span>
            </a>
            <a href="/budget" class="nav-item">
                <span class="nav-icon">üéØ</span>
                <span>Budget</span>
            </a>
            <a href="/settings" class="nav-item">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <script>
        // ========== UTILITY FUNCTIONS ==========
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return 'Rp ' + num.toLocaleString('id-ID');
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const day = date.getDate();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                return day + ' ' + months[date.getMonth()];
            } catch {
                return '';
            }
        }

        // ========== DATA ACCESS ==========
        function getStoragePrefix() {
            // Check for guest mode cookie
            try {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'duit-guest-mode' && value === 'true') {
                        return 'guest';
                    }
                }
            } catch { }

            // Look for any authenticated user data
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('duit_auth_') && key.endsWith('_wallets')) {
                        const userId = key.replace('duit_auth_', '').replace('_wallets', '');
                        return 'duit_auth_' + userId;
                    }
                }
            } catch { }

            return 'guest';
        }

        function getData(type) {
            try {
                const prefix = getStoragePrefix();
                const key = prefix + '_' + type;
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch {
                return [];
            }
        }

        function getWallets() {
            const wallets = getData('wallets');
            return wallets.sort((a, b) => (a.order || 0) - (b.order || 0));
        }

        function getTransactions() {
            const transactions = getData('transactions');
            return transactions.sort((a, b) =>
                new Date(b.date).getTime() - new Date(a.date).getTime()
            );
        }

        function getCategories() {
            return getData('categories');
        }

        // ========== RENDER FUNCTIONS ==========
        function renderWallets(wallets) {
            const container = document.getElementById('wallets-container');

            if (!wallets || wallets.length === 0) {
                container.innerHTML = '<div class="add-wallet-card"><div class="add-icon">‚ûï</div><div style="font-weight:600;color:#1e293b;">Buat Wallet</div><div style="font-size:13px;color:#64748b;">Mulai catat keuangan</div></div>';
                return;
            }

            const colors = ['blue', 'purple', 'pink', 'green'];
            const icons = { 'CASH': 'üíµ', 'BANK': 'üè¶', 'E_WALLET': 'üì±', 'CREDIT_CARD': 'üí≥' };

            container.innerHTML = wallets.slice(0, 4).map((wallet, i) => {
                const color = colors[i % colors.length];
                const icon = icons[wallet.type] || 'üí∞';
                const typeName = (wallet.type || '').replace('_', ' ');
                return '<div class="wallet-card"><div class="wallet-icon ' + color + '">' + icon + '</div><div class="wallet-name">' + (wallet.name || 'Wallet') + '</div><div class="wallet-type">' + typeName + '</div><div class="wallet-balance">' + formatCurrency(wallet.balance) + '</div></div>';
            }).join('');
        }

        function renderTransactions(transactions, categories) {
            const container = document.getElementById('transactions-container');
            const recent = (transactions || []).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada transaksi</div>';
                return;
            }

            const catMap = {};
            (categories || []).forEach(c => { catMap[c.id] = c; });

            const icons = {
                'INCOME': 'üí∞',
                'EXPENSE': 'üõí',
                'restaurant': 'üçî',
                'directions_bus': 'üöå',
                'shopping_bag': 'üõçÔ∏è',
                'home': 'üè†',
                'movie': 'üé¨',
                'medical_services': 'üè•',
                'school': 'üìö',
                'work': 'üíº',
                'store': 'üè™',
                'card_giftcard': 'üéÅ',
                'trending_up': 'üìà',
                'attach_money': 'üíµ'
            };

            container.innerHTML = recent.map(tx => {
                const cat = catMap[tx.categoryId];
                const isIncome = tx.type === 'INCOME';
                const icon = icons[cat?.icon] || (isIncome ? 'üí∞' : 'üõí');
                const catName = cat?.name || 'Lainnya';
                return '<div class="transaction-item"><div class="transaction-left"><div class="transaction-icon">' + icon + '</div><div><div class="transaction-category">' + catName + '</div><div class="transaction-date">' + formatDate(tx.date) + '</div></div></div><div class="transaction-amount ' + (isIncome ? 'income' : 'expense') + '">' + (isIncome ? '+' : '-') + formatCurrency(tx.amount) + '</div></div>';
            }).join('');
        }

        function renderStats(wallets, transactions) {
            const totalBalance = (wallets || []).reduce((sum, w) => sum + parseFloat(w.balance || 0), 0);

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthTx = (transactions || []).filter(t => {
                try { return new Date(t.date) >= startOfMonth; } catch { return false; }
            });

            const income = thisMonthTx.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const expense = thisMonthTx.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

            document.getElementById('total-balance').textContent = formatCurrency(totalBalance);
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expense').textContent = formatCurrency(expense);
        }

        // ========== MAIN ==========
        function init() {
            try {
                const wallets = getWallets();
                const transactions = getTransactions();
                const categories = getCategories();

                renderWallets(wallets);
                renderTransactions(transactions, categories);
                renderStats(wallets, transactions);
            } catch (e) {
                console.error('Error initializing:', e);
            }
        }

        // Run immediately
        init();
    </script>
</body>

</html>